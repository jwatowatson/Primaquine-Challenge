---
title: "Primaquine challenge studies"
format: html
editor: visual
---

```{r preambule}
#| echo: false
knitr::opts_chunk$set(cache = F, cache.comments = FALSE,
                      echo = F, include = TRUE, 
                      fig.width = 8, fig.height = 8,
                      fig.pos = 'H',dev = 'png', dpi = 300)
library(RColorBrewer)
library(readr)
library(tidyverse)
```

## Load all data

```{r load_data}
load('PQdata.rds')

PQdat_all = PQdat %>% arrange(study, label, Time); rm(PQdat)
PQdat_all$Unique_ID = ifelse(is.na(PQdat_all$Ascending_ID),
                             PQdat_all$label, PQdat_all$Ascending_ID)
# color ramp for plots
my_pal = colorRampPalette(colors = rev(brewer.pal(n = 9,name = 'RdYlBu')))
PQdat_all$G6PD_variant_pch = as.numeric(as.factor(PQdat_all$G6PD_variant))
```

## Endpoint definitions

See SAP where these are outlined.

We compute all endpoints and exposure summaries for all subjects in both sub-studies

```{r endpoints}
PQdat = PQdat_all %>% 
  filter(label !="PQ-mrdt01-018") %>%
  group_by(label) %>%
  mutate(
    Day10_total_PQ = ifelse(study=='Part1',sum(PQ_mg_kg[Day<=10]),NA),
    Total_PQ = sum(PQ_mg_kg),
    col_dose = 
      case_when(
        study=='Part1' ~ my_pal(19)[(round(Day10_total_PQ,1)*10)-16],
        study=='Part2' ~ my_pal(5)[(round(Total_PQ,1)*10) - 4]     
      ),
    Hb_fall_absolute = Mean_hb-Baseline_Hb,
    Hb_fall_relative = 100*(Hb_fall_absolute)/Baseline_Hb, # as percentage
    Max_hb_fall_abs = min(Hb_fall_absolute,na.rm=T),
    Max_hb_fall_rel = min(Hb_fall_relative, na.rm=T),
    Hb_nadir=min(Mean_hb, na.rm = T),
    Retic_max=max(Mean_retic, na.rm = T),
    Day_Hb_nadir=Day[which.min(Mean_hb)],
    Day_Retic_max=Day[which.max(Mean_retic)],
    unique_day = !duplicated(Day),
    rate_include = 
      case_when(study=='Part1' & Day>=5 & Day<=10 & unique_day ~ 1,
                study=='Part2' & Day>=0 & Day<=7 & unique_day ~ 1),
    Rate_Hb_fall = -coef(lm(Mean_hb ~ Day*rate_include))['Day'],
    AST_fold_change = log2(lbbiast/Baseline_AST),
    ALT_fold_change = log2(lbbialt/Baseline_ALT),
    Creat_fold_change = log2(lbbicrea/Baseline_Creatinine),
    Tot_bili_absolute = lbbittol-Baseline_TotBili,
    LDH_absolute = lbbildh-Baseline_LDH,
    Max_AST_increase = max(AST_fold_change, na.rm = T),
    Max_ALT_increase = max(ALT_fold_change, na.rm = T),
    Max_Creat_increase = max(Creat_fold_change, na.rm = T),
    Max_TBR_increase = max(Tot_bili_absolute, na.rm = T),
    Max_Hillmen = max(urine_color, na.rm = T)
  )
```


## Table 1

Baseline characteristics 

```{r Table1}
PQ_unique = PQdat_all %>% filter(!duplicated(label)) 

writeLines('G6PD variants')
PQ_unique %>%
  group_by(study, G6PD_variant) %>%
  summarise(n = n())
PQ_unique %>% filter(!duplicated(Unique_ID)) %>%
  group_by(G6PD_variant) %>%
  summarise(n = n())

writeLines('Age (years):')
PQ_unique %>%
  group_by(study) %>%
  summarise(Age = quantile(agey, probs=c(0, .5, 1)))
PQ_unique %>% ungroup %>% summarise(Age = quantile(agey, probs=c(0, .5, 1)))

writeLines('Weight (kg):')
PQ_unique %>%
  group_by(study) %>%
  summarise(Weight = quantile(weight, probs=c(0, .5, 1)))
PQ_unique %>% ungroup %>% summarise(Weight = quantile(weight, probs=c(0, .5, 1)))


writeLines('Baseline Hb:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline Hb` = quantile(Baseline_Hb, probs=c(0, .5, 1)))

writeLines('Baseline retics:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline Hb` = quantile(Baseline_Retic, probs=c(0, .5, 1)))

PQ_unique %>%
  group_by(study) %>%
  summarise(`Proportion baseline retic >2%` = sum(Baseline_Retic>=2))


writeLines('Baseline platelets:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline platelets` = quantile(Baseline_platelets, probs=c(0, .5, 1)))

writeLines('Baseline WBC:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline WBC` = quantile(Baseline_WBC, probs=c(0, .5, 1)))

writeLines('Baseline metHb:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline metHb` = quantile(Baseline_metHb, probs=c(0, .5, 1)))

writeLines('Baseline AST:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline AST` = quantile(Baseline_AST, probs=c(0, .5, 1)))

writeLines('Baseline ALT:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline ALT` = quantile(Baseline_ALT, probs=c(0, .5, 1)))

writeLines('Baseline creatinine:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline creatinine` = quantile(Baseline_Creatinine, probs=c(0, .5, 1)))

writeLines('Baseline total bilirubiun:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Baseline TBR` = quantile(Baseline_TotBili, probs=c(0, .5, 1)))
```


# Summary of endpoints and exposures

```{r endpoint_summary}
writeLines('Nadir haemoglobin and peak retics:')
PQdat %>% group_by(study) %>%
  summarise(
    `Min Hb (g/dL)` = quantile(Hb_nadir[!duplicated(label)],
                               probs = c(0,0.5,1)),
    `Max retic (%)` = quantile(Retic_max[!duplicated(label)],
                                          probs = c(0,0.5,1))
  )

writeLines('day 10 dose:')
PQdat %>% group_by(study) %>%
  summarise(
    `Day10 PQ` = quantile(Day10_total_PQ[!duplicated(label)],
                               probs = c(0,0.5,1),na.rm = T)
  )

writeLines('Haemoglobin falls in ascending dose regimens (median and range):')
PQdat %>% group_by(study) %>%
  summarise(
    `Max absolute Hb fall (g/dL)` = quantile(Max_hb_fall_abs[!duplicated(label)],
                                             probs = c(0,0.5,1)),
    `Max relative Hb fall (%)` = quantile(Max_hb_fall_rel[!duplicated(label)],
                                          probs = c(0,0.5,1))
  )

writeLines('Day of Haemoglobin nadir and reticulocyte peak (median, observed):')
PQdat %>% group_by(study) %>%
  summarise(
    `Day of Hb nadir` = quantile(Day_Hb_nadir[!duplicated(label)],probs=c(0,.5,1)),
    `Day of reticulocyte peak` = quantile(Day_Retic_max[!duplicated(label)],probs=c(0,.5,1))
  )


PQ_unique = PQdat %>% filter(!duplicated(label)) 

writeLines('Day of Hb_nadir:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Day Hb nadir` = quantile(Day_Hb_nadir, probs=c(0, .5, 1)))

writeLines('Day of peak retics:')
PQ_unique %>%
  group_by(study) %>%
  summarise(`Day peak reticulocytes` = quantile(Day_Retic_max, probs=c(0, .5, 1)))

```



## Part 1

```{r Fig1}
PQ_part1 = PQdat %>% filter(study=='Part1') %>%
  group_by(label, Day) %>%
  mutate(PQ_mg_kg_cum=mean(PQ_mg_kg_cum),
         Mean_hb=mean(Mean_hb, na.rm = T),
         Mean_retic=mean(Mean_retic, na.rm = T),
         Hb_fall_relative=mean(Hb_fall_relative, na.rm = T))
par(las=1, mfrow=c(2,2), family='serif', cex.lab=1.3, cex.axis=1.3, mar=c(5,5,3,2))
plot(NA, NA, panel.first=grid(), xaxt='n',
     xlab='Days since start of primaquine',
     ylab ='Total PQ dose (mg/kg)',xlim=c(0,28),
     ylim = c(0, max(PQ_part1$PQ_mg_kg_cum)))
for(id in unique(PQ_part1$label)){
  ind = PQ_part1$label==id & !duplicated(PQ_part1[, c('Day','label')])
  lines(PQ_part1$Time[ind], PQ_part1$PQ_mg_kg_cum[ind],
        col = PQ_part1$col_dose[ind],lwd=1.5)
}
axis(1, at = c(0, 10, 20 , 28))
abline(v=10, lty=2, lwd=2, col='grey')
mtext(text = 'a',side = 3,line = 1,cex = 1.5,adj = 0)

plot(PQ_part1$Time, 
     PQ_part1$Mean_hb, pch ='.',xlim=c(0,28),
     xlab='Days since start of primaquine',type='n',xaxt='n',
     ylab = 'Haemoglobin (g/dL)', panel.first =grid())
for(id in unique(PQ_part1$label)){
  ind = PQ_part1$label==id& !duplicated(PQ_part1[, c('Day','label')])
  lines(PQ_part1$Time[ind], PQ_part1$Mean_hb[ind],
        col = PQ_part1$col_dose[ind],lwd=1.5)
}
axis(1, at = c(0, 10, 20 , 28))
mtext(text = 'b',side = 3,line = 1,cex = 1.5,adj = 0)

plot(PQ_part1$Time,
     PQ_part1$Mean_retic, xlim=c(0,28),type='n',xaxt='n',
     pch ='.', xlab='Days since start of primaquine',
     ylab = 'Reticulocytes (%)', panel.first =grid())
for(id in unique(PQ_part1$label)){
  ind = PQ_part1$label==id & 
    !is.na(PQ_part1$Mean_retic) & !duplicated(PQ_part1[, c('Day','label')])
  lines(PQ_part1$Time[ind], PQ_part1$Mean_retic[ind],
        col = PQ_part1$col_dose[ind],lwd=1.5)
}
mtext(text = 'c',side = 3,line = 1,cex = 1.5,adj = 0)
axis(1, at = c(0, 10, 20 , 28))


plot(PQ_part1$Time, PQ_part1$Hb_fall_relative,
     xlim=c(0,28), type='n', xaxt='n',
     pch ='.', xlab='Days since start of primaquine',
     ylab = 'Baseline haemoglobin (%)', panel.first =grid())
for(id in unique(PQ_part1$label)){
  ind = PQ_part1$label==id & !duplicated(PQ_part1[, c('Day','label')]) & 
    !is.na(PQ_part1$Hb_fall_relative)
  lines(PQ_part1$Time[ind],
        PQ_part1$Hb_fall_relative[ind],
        col = PQ_part1$col_dose[ind],lwd=1.5)
}
axis(1, at = c(0, 10, 20 , 28))
mtext(text = 'd',side = 3,line = 1,cex = 1.5,adj = 0)
```

## Part 2

```{r Fig2}
par(las=1, mfrow=c(2,2), family='serif', cex.lab=1.3, cex.axis=1.3)

PQ_part2 = PQdat %>% filter(study=='Part2') %>%
  group_by(label, Day) %>%
  mutate(Mean_hb=mean(Mean_hb, na.rm = T),
         Mean_retic=mean(Mean_retic, na.rm = T),
         Hb_fall_relative=mean(Hb_fall_relative, na.rm = T))

plot(PQ_part2$Time, PQ_part2$Mean_hb, pch ='.',xlim=c(0,14),
     xlab='Days since start of primaquine',type='n',xaxt='n',
     ylab = 'Haemoglobin (g/dL)', panel.first =grid())
for(id in unique(PQ_part2$label)){
  ind = PQ_part2$label==id & !duplicated(PQ_part2[, c('Day','label')])
  lines(PQ_part2$Time[ind], PQ_part2$Mean_hb[ind],
        col = PQ_part2$col_dose[ind],lwd=1.5)
}
axis(1, at = c(0, 7, 14))
mtext(text = 'a',side = 3,line = 1,cex = 1.5,adj = 0)

plot(PQ_part2$Time,
     PQ_part2$Mean_retic, xlim=c(0,14),type='n',xaxt='n',
     pch ='.', xlab='Days since start of primaquine',
     ylab = 'Reticulocytes (%)', panel.first =grid())
for(id in unique(PQ_part2$label)){
  ind = PQ_part2$label==id & !duplicated(PQ_part2[, c('Day','label')]) &
    !is.na(PQ_part2$Mean_retic)
  lines(PQ_part2$Time[ind], PQ_part2$Mean_retic[ind],
        col = PQ_part2$col_dose[ind],lwd=1.5)
}
mtext(text = 'b',side = 3,line = 1,cex = 1.5,adj = 0)
axis(1, at = c(0, 7, 14))


plot(PQ_part2$Time, PQ_part2$Hb_fall_relative,
     xlim=c(0,14), type='n', xaxt='n',
     pch ='.', xlab='Days since start of primaquine',
     ylab = 'Baseline haemoglobin (%)', panel.first =grid())
for(id in unique(PQ_part2$label)){
  ind = PQ_part2$label==id & !duplicated(PQ_part2[, c('Day','label')]) & 
    !is.na(PQ_part2$Mean_hb)
  lines(PQ_part2$Time[ind],
        PQ_part2$Hb_fall_relative[ind],
        col = PQ_part2$col_dose[ind],lwd=1.5)
}
axis(1, at = c(0, 7, 14))
mtext(text = 'c',side = 3,line = 1,cex = 1.5,adj = 0)


plot(NA,NA,xlim=0:1,ylim=0:1,xlab='', ylab='',xaxt='n',yaxt='n',bty='n')
ind_show = c(0.52,0.60,0.70,0.80,0.87)
legend('left',inset = 0.02,title = 'mg/kg dose',
       legend = ind_show,cex=1.3,bty='y',
       col = my_pal(36)[100*ind_show-51],lwd=2)
```

## Dose response part 1

```{r Fig3}
g6pd_cols = brewer.pal(8,name = 'Set2')
names(g6pd_cols) = unique(PQdat$G6PD_variant)
PQ_unique %>% group_by(study) %>%
  summarise(`Total day 10 dose (mg/kg)` = quantile(Day10_total_PQ, probs = c(0,.5,1),na.rm=T))

par(mfrow=c(2,3),las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
plot(PQ_unique$Day10_total_PQ, PQ_unique$Max_hb_fall_abs,
     xlim = c(1.5, 3.5), xlab = "Day 10 cumulative dose (mg/kg)",
     ylab = 'Maximum fall from baseline (g/dL)', panel.first = grid(),
     pch = PQ_unique$G6PD_variant_pch, cex=1.5,
     col = g6pd_cols[PQ_unique$G6PD_variant] )
mod=lm(Max_hb_fall_abs~Day10_total_PQ,data = PQ_unique)
summary(mod)
abline(mod,lty=2,lwd=2)
legend('topright', inset = 0.03, legend = unique(PQ_unique$G6PD_variant),
       col = g6pd_cols[unique(PQ_unique$G6PD_variant)],
       bty='n',pch=unique(PQ_unique$G6PD_variant_pch),cex=1)
mtext(text = 'a',side = 3,line = 1,cex = 1.5,adj = 0)


plot(PQ_unique$Day10_total_PQ, PQ_unique$Max_hb_fall_rel,
     xlim = c(1.5, 3.5), xlab = "Day 10 cumulative dose (mg/kg)",
     ylab = 'Relative fall from baseline (%)', panel.first = grid(),
     pch = PQ_unique$G6PD_variant_pch, cex=1.5,
     col = g6pd_cols[PQ_unique$G6PD_variant] )
mod=lm(Max_hb_fall_rel~Day10_total_PQ,data = PQ_unique)
summary(mod)
abline(mod,lty=2,lwd=2)
mtext(text = 'b',side = 3,line = 1,cex = 1.5,adj = 0)


plot(PQ_unique$Day10_total_PQ, PQ_unique$Rate_Hb_fall,
     xlim = c(1.5, 3.5),
     xlab = "Day 10 cumulative dose (mg/kg)",
     ylab = 'Mean fall: days 5-10 (g/dL) ', panel.first = grid(),
     pch = PQ_unique$G6PD_variant_pch, cex=1.5,
     col = g6pd_cols[PQ_unique$G6PD_variant] )
mod=lm(Rate_Hb_fall~Day10_total_PQ,data = PQ_unique)
summary(mod)
abline(mod,lty=2,lwd=2)
mtext(text = 'c',side = 3,line = 1,cex = 1.5,adj = 0)

ind_part2 = PQ_unique$study=='Part2'
plot(PQ_unique$Total_PQ[ind_part2], PQ_unique$Max_hb_fall_abs[ind_part2],
     xlab = "PQ single dose (mg/kg)",
     ylab = 'Maximum fall from baseline (g/dL)', panel.first = grid(),
     pch = PQ_unique$G6PD_variant_pch[ind_part2], cex=1.5,
     col = g6pd_cols[PQ_unique$G6PD_variant[ind_part2]] )
mod=lm(Max_hb_fall_abs~Total_PQ,data = PQ_unique[ind_part2,])
summary(mod)
abline(mod,lty=2,lwd=2)
mtext(text = 'd',side = 3,line = 1,cex = 1.5,adj = 0)

plot(PQ_unique$Total_PQ[ind_part2], PQ_unique$Max_hb_fall_rel[ind_part2],
     xlab = "PQ single dose (mg/kg)",
     ylab = 'Relative fall from baseline (%)', panel.first = grid(),
     pch = PQ_unique$G6PD_variant_pch[ind_part2], cex=1.5,
     col = g6pd_cols[PQ_unique$G6PD_variant[ind_part2]] )
mod=lm(Max_hb_fall_rel~Total_PQ,data = PQ_unique[ind_part2,])
summary(mod)
abline(mod,lty=2,lwd=2)
mtext(text = 'e',side = 3,line = 1,cex = 1.5,adj = 0)


plot(PQ_unique$Total_PQ[ind_part2], PQ_unique$Rate_Hb_fall[ind_part2],
     xlab = "PQ single dose (mg/kg)",
     ylab = 'Mean fall: days 0-7 (g/dL) ', panel.first = grid(),
     pch = PQ_unique$G6PD_variant_pch[ind_part2], cex=1.5,
     col = g6pd_cols[PQ_unique$G6PD_variant[ind_part2]] )
mod=lm(Rate_Hb_fall~Total_PQ,data = PQ_unique[ind_part2,])
summary(mod)
abline(mod,lty=2,lwd=2)
mtext(text = 'f',side = 3,line = 1,cex = 1.5,adj = 0)

```

Additional predictive models

```{r part1_pred_model}
mod=lm(Max_hb_fall_abs~Day10_total_PQ+Baseline_Retic+Baseline_Hb,data = PQ_unique[!ind_part2, ])
summary(mod)

mod=lm(Max_hb_fall_rel~Day10_total_PQ+Baseline_Retic+Baseline_Hb,data = PQ_unique[!ind_part2, ])
summary(mod)
```

## comparing both studies

```{r comparison_endpoints, fig.height=6, fig.width=8}
par(mfrow=c(1,2),las=1)

for(my_col in c('Max_hb_fall_abs','Max_hb_fall_rel')){
  plot(PQ_unique$Total_PQ, t(PQ_unique[,my_col]),
       panel.first=grid(),
       pch=16 + as.numeric(PQ_unique$study=='Part1'),
       xlim=c(0,8.5),
       ylab='Maximum fall in haemoglobin (g/dL)',
       xlab = "Total PQ dose (mg/kg)",col='darkblue')
  for(id in unique(PQ_unique$Ascending_ID[!is.na(PQ_unique$Ascending_ID)&PQ_unique$study=='Part2'])){
    i = which(PQ_unique$label==id&PQ_unique$study=='Part1')
    j = which(PQ_unique$Ascending_ID==id&PQ_unique$study=='Part2')
    lines(c(PQ_unique$Total_PQ[i],
            PQ_unique$Total_PQ[j]),
          c(PQ_unique[i,my_col],
            PQ_unique[j,my_col]), lty=2,
          col = 'lightgrey', lwd=2)
  }
  abline(h=median(t(PQ_unique[!ind_part2,my_col]),na.rm=T),
         lty=2,col='darkblue',lwd=2)
  abline(h=median(t(PQ_unique[ind_part2,my_col])),lty=2,col='pink',lwd=2)
  points(PQ_unique$Total_PQ[ind_part2], t(PQ_unique[ind_part2,my_col]),
         col='pink',pch=16)
  points(PQ_unique$Total_PQ[!ind_part2], t(PQ_unique[!ind_part2,my_col]),
         col='darkblue',pch=17)
  text(x=1,y=0.5,'Single\ndose',col='pink')
  text(x=5,y=0.5,'Ascending\ndose',col='darkblue')
}
```

Daily falls

```{r daily_hb_fall, fig.height=7,fig.width=8}
daily_change1 = PQdat %>% 
  filter(study=='Part1', Day>=0) %>% 
  group_by(label, Day) %>% 
  summarise(Mean_hb = mean(Mean_hb, na.rm=T)) %>%
  group_by(label) %>%
  mutate(Daily_hb_change = c(0,diff(Mean_hb)))

daily_change2 = PQdat %>% 
  filter(study=='Part2', Day>=0) %>% 
  group_by(label, Day) %>% 
  summarise(Mean_hb = mean(Mean_hb, na.rm=T)) %>%
  group_by(label) %>%
  mutate(Daily_hb_change = c(0,diff(Mean_hb)))

par(las=1, mfrow=c(1,2), family='serif', cex.lab=1.3, cex.axis=1.3)
ylims=c(-2,2)
plot(daily_change1$Day,daily_change1$Daily_hb_change,
     xlim = c(0,28),  panel.first=grid(),
     xlab='Day of study',
     ylab='Change in haemoglobin (g/dL)')
mtext(text = 'Part 1: ascending dose',side = 3,line = 1.5,adj = 0)
for(id in unique(daily_change1$label)){
  ind = daily_change1$label==id
  lines(daily_change1$Day[ind],
        daily_change1$Daily_hb_change[ind],
        col= adjustcolor('lightgrey',.6))
}
xx_daily_fall = aggregate(Daily_hb_change~Day, data = daily_change1,median)
lines(xx_daily_fall$Day, xx_daily_fall$Daily_hb_change,lwd=3,col='red')
abline(h=0,lty=2, lwd=2)


plot(daily_change2$Day,daily_change2$Daily_hb_change,
     xlim = c(0,14),  panel.first=grid(),
     xlab='Day of study',ylim=ylims,
     ylab='Change in haemoglobin (g/dL)')
mtext(text = 'Part 2: single dose',side = 3,line = 1.5,adj = 0)
xx_daily_fall = aggregate(Daily_hb_change~Day, data = daily_change2,median)
lines(xx_daily_fall$Day, xx_daily_fall$Daily_hb_change,lwd=3,col='red')
abline(h=0,lty=2, lwd=2)


for(id in unique(daily_change2$label)){
  ind = daily_change2$label==id
  lines(daily_change2$Day[ind],
        daily_change2$Daily_hb_change[ind],
        col= adjustcolor('lightgrey',.6))
}

ids1 = unique(daily_change1$label[which(daily_change1$Daily_hb_change< -1)])
ids2 = unique(daily_change2$label[which(daily_change2$Daily_hb_change< -1)])

writeLines(sprintf('A total of %s subjects in ascending dose had greater than 1 g/dL decrease over subsequent visits',
                   length(ids1)))
```



```{r individ_big_falls}
PQ_daily = PQdat %>% filter(label %in% union(ids1, ids2)) %>%
  group_by(label, Day) %>%
  summarise(Haemocue_hb=mean(Haemocue_hb,na.rm = T),
            CBC_hb=mean(CBC_hb, na.rm = T),
            Mean_hb=mean(Mean_hb, na.rm = T),
            PQdose=sum(PQdose))

par(mfrow=c(3,3),mar=c(4,4,2,2),las=1, family='serif')
for(id in c(ids1,ids2)){
  ind = PQ_daily$label==id
  xlims = c(0, max(PQ_daily$Day[ind]))
  plot(PQ_daily$Day[ind],PQ_daily$Mean_hb[ind],type='b',
       xlab='', ylab='Hb (g/dL)', 
       panel.first=grid(),xlim=xlims,
       main=id,pch=16)
  points(PQ_daily$Day[ind], PQ_daily$CBC_hb[ind],col='blue')
  points(PQ_daily$Day[ind], PQ_daily$Haemocue_hb[ind],col='red')
  mtext(text = 'Day of study',side = 1,line = 3)
  
  js = which(PQ_daily$PQdose>0 & ind)
  js = c(head(js,1), tail(js,1))
  polygon(PQ_daily$Day[c(js, rev(js))],
          c(1,1,20,20),col=adjustcolor('grey',.4),border = NA)
  lines(PQ_daily$Day[ind],PQ_daily$Mean_hb[ind],type='b')
  j=which(ind & c(0,diff(PQ_daily$Mean_hb))< -1)
  abline(v=PQ_daily$Day[j],col='red',lwd=2,lty=2)
}
```

## Individual data

```{r individ_profiles_part1_2, fig.width=8, fig.height=8}

for(my_p in c('Part1', 'Part2')){
  par(mfcol=c(4,4),las=1, family='serif', mar = c(0,5,2,2),cex.lab=1.3,cex.axis=1.3)
  xs = c(1,2,2,3,3,3)
  layout(mat = matrix(data = c(xs, xs+3, xs+6),nrow = 6,byrow = F))
  for(id in unique(PQdat$label[PQdat$study==my_p])){
    PQdat_id = PQdat %>% filter(label==id, Day>=0) %>%
      group_by(Day) %>% 
      mutate(PQdose_daily = sum(PQdose),
             Manual_retic=mean(Manual_retic,na.rm=T),
             CBC_retic=mean(CBC_retic,na.rm=T),
             CBC_hb=mean(CBC_hb,na.rm=T),
             Haemocue_hb=mean(Haemocue_hb,na.rm = T))
    
    par(mar = c(0,5,4,2))
    plot(PQdat_id$Day, PQdat_id$PQdose_daily,xlab='',
         type='l', ylab='mg',xaxt='n',
         main=paste0(id, ' (',PQdat$G6PD_variant[ind][1],')'))
    par(mar = c(0,5,0,2))
    # retics
    plot(PQdat_id$Day,
         PQdat_id$Manual_retic,
         panel.first = grid(),
         ylim = c(0,18), col='darkblue',
         main = '',
         pch=16, ylab='Reticulocyte (%)',
         xlab = '', xaxt='n')
    points(PQdat_id$Day,
           PQdat_id$CBC_retic, pch=17,col='darkred')
    par(mar = c(4,5,0,2))
    
    plot(PQdat_id$Day,
         PQdat_id$Haemocue_hb,
         panel.first = grid(),col='darkblue',
         ylim = range(union(PQdat$Haemocue_hb,
                            PQdat$CBC_hb),na.rm = T),
         main = '',pch=16, ylab='Haemoglobin (g/dL)',
         xlab = '')
    mtext(text = 'Days since starting PQ',side = 1,line = 3,cex=.8)
    points(PQdat_id$Day,
           PQdat_id$CBC_hb, pch=17,col='darkred')
  }
}
```



patients who got both

```{r comparison_both_parts}
ids_both = sort(unique(PQdat$Ascending_ID[!is.na(PQdat$Ascending_ID)&PQdat$study=='Part2']))

par(las=1, family='serif')
layout(mat = matrix(c(1,2,2,3,4,4,
                      5,6,6,7,8,8),
                    # 9,10,10,11,12,12,
                    # 13,14,14,15,16,16),
                    nrow = 6,byrow = F))
for(id in ids_both){
  par(mar=c(0,5,4,2))
  ind_dose = PQdat$label==id
  plot(PQdat$Time[ind_dose],
       PQdat$PQ_cumulative[ind_dose],type='l',lwd=2,
       ylab='',xlab = '',xaxt='n', panel.first=grid(), xlim=c(0,20),
       ylim = range(PQdat$PQ_cumulative), col='darkblue')
  abline(h=45, lty=2,lwd=2, col='pink')
  ind = PQdat$label==id&PQdat$study=='Part1'
  ind2 = PQdat$Ascending_ID==id&PQdat$study=='Part2'
  title(paste0(id, ' (',PQdat$G6PD_variant[ind][1],')'))
  
  par(mar=c(5,5,0,2))
  plot(PQdat$Time[ind], PQdat$Mean_hb[ind],
       xlim = c(0,20), panel.first=grid(),type='b',ylim = c(8.5, 16),lwd=2,
       xlab='Days since starting PQ', ylab='Haemoglobin (g/dL)',col='darkblue')
  lines(PQdat$Time[ind2], PQdat$Mean_hb[ind2], type='b',col='pink',lwd=2)
}
```

drop in haemoglobin once PQ was stopped

```{r}
# PQdat = dplyr::arrange(PQdat, label, Time)
# PQdat$final_dose = NA
# PQdat$post_regimen_drop = NA
# for(id in unique(PQdat$label)){
#   ind = PQdat$label==id
#   j_last = tail(which(ind & PQdat$sddose>0), 1)
#   PQdat$final_dose[ind] = PQdat$sddose[j_last]
#   
#   fup_ind = which(ind & PQdat$Time>0 & PQdat$sddose==0 & !is.na(PQdat$Mean_hb))
#   PQdat$post_regimen_drop[ind] = max(PQdat$Mean_hb[j_last]-PQdat$Mean_hb[fup_ind])
# }
# Ascending_base_dat = PQdat[!duplicated(PQdat$label),]
# 
# par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
# plot(Ascending_base_dat$final_dose/Ascending_base_dat$weight,
#      Ascending_base_dat$post_regimen_drop,
#      xlab='Final dose given (mg)',ylab='Maximum fall post final dose',
#      panel.first=grid())
```

## Liver toxicity

Normalised increases:

```{r ast_alt_creat_totalbili}
par(las=1, mfrow=c(2,2), family='serif', cex.lab=1.3, cex.axis=1.3)
plot(PQdat$Time, PQdat$AST_fold_change,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'AST (fold change)',
     yaxt='n', panel.first=grid())
axis(2, at = -1:3, labels = 2^(-1:3))
for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$lbbiast)
  lines(PQdat$Time[ind],
        PQdat$AST_fold_change[ind],
        col=PQdat$col_dose[ind],lwd=2)
}
text(17, 3.2, '14')
text(5, 2.7, '15')


plot(PQdat$Time, PQdat$ALT_fold_change,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'ALT (fold change)',
     yaxt='n', panel.first=grid())
axis(2, at = -1:4, labels = 2^(-1:4))
for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$lbbialt)
  lines(PQdat$Time[ind],
        PQdat$ALT_fold_change[ind],
        col=PQdat$col_dose[ind],lwd=2)
}

text(13, 3.2, '7')
text(17, 4.2, '14')
text(5, 4, '15')


plot(PQdat$Time, PQdat$Creat_fold_change,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'Creatinine (fold change)',
     yaxt='n', panel.first=grid())
axis(2, at = c(-0.4, -.2, 0 , .2, .4), labels = round(2^c(-0.4, -.2, 0 , .2, .4),2))
for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$lbbicrea)
  lines(PQdat$Time[ind],
        log2(PQdat$lbbicrea/PQdat$Baseline_Creatinine)[ind],
        col=PQdat$col_dose[ind],lwd=2)
}


## Total Bilirubin
plot(PQdat$Time, PQdat$Tot_bili_absolute,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'Total bilirubin (absolute increase from baseline)',
     panel.first=grid())

for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$Tot_bili_absolute)
  lines(PQdat$Time[ind],
        (PQdat$Tot_bili_absolute)[ind],
        col=PQdat$col_dose[ind],lwd=2)
}
text(9.5, 3.3, '15')
```


```{r ast_alt_creat_totalbili_raw}
par(las=1, mfrow=c(2,2), family='serif', cex.lab=1.3, cex.axis=1.3)
plot(PQdat$Time, log2(PQdat$lbbiast),
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'AST',
     yaxt='n', panel.first=grid())
axis(2, at = 4:8, labels = 2^(4:8))
for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$lbbiast)
  lines(PQdat$Time[ind],
        log2(PQdat$lbbiast[ind]),
        col=PQdat$col_dose[ind],lwd=2)
}
text(17, 3.2, '14')
text(5, 2.7, '15')


plot(PQdat$Time, PQdat$ALT_fold_change,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'ALT (fold change)',
     yaxt='n', panel.first=grid())
axis(2, at = -1:4, labels = 2^(-1:4))
for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$lbbialt)
  lines(PQdat$Time[ind],
        PQdat$ALT_fold_change[ind],
        col=PQdat$col_dose[ind],lwd=2)
}

text(13, 3.2, '7')
text(17, 4.2, '14')
text(5, 4, '15')


plot(PQdat$Time, PQdat$Creat_fold_change,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'Creatinine (fold change)',
     yaxt='n', panel.first=grid())
axis(2, at = c(-0.4, -.2, 0 , .2, .4), labels = round(2^c(-0.4, -.2, 0 , .2, .4),2))
for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$lbbicrea)
  lines(PQdat$Time[ind],
        log2(PQdat$lbbicrea/PQdat$Baseline_Creatinine)[ind],
        col=PQdat$col_dose[ind],lwd=2)
}


## Total Bilirubin
plot(PQdat$Time, PQdat$Tot_bili_absolute,
     xlab = 'Time (days)', xlim = c(-1, 28), 
     ylab = 'Total bilirubin (absolute increase from baseline)',
     panel.first=grid())

for(id in unique(PQdat$label)){
  ind = PQdat$label==id & !is.na(PQdat$Tot_bili_absolute)
  lines(PQdat$Time[ind],
        (PQdat$Tot_bili_absolute)[ind],
        col=PQdat$col_dose[ind],lwd=2)
}
text(9.5, 3.3, '15')
```


Look at the dose-reponse for liver tox
```{r}
ind_part1=PQ_unique$study=='Part1'
summary(lm(Max_ALT_increase ~ Day10_total_PQ, data = PQ_unique[ind_part1, ]))
plot(PQ_unique$Day10_total_PQ, PQ_unique$Max_ALT_increase)

summary(lm(Max_AST_increase ~ Day10_total_PQ, data = PQ_unique[ind_part1, ]))
plot(PQ_unique$Day10_total_PQ, PQ_unique$Max_AST_increase)

summary(lm(Max_Creat_increase ~ Day10_total_PQ, data = PQ_unique[ind_part1, ]))
plot(PQ_unique$Day10_total_PQ, PQ_unique$Max_Creat_increase)

summary(lm(Max_TBR_increase ~ Day10_total_PQ, data = PQ_unique[ind_part1, ]))
plot(PQ_unique$Day10_total_PQ, PQ_unique$Max_TBR_increase)
```




## Subject 11

```{r subject11, fig.width=8, fig.height=6}
par(las=1, family='serif',cex.lab=1.3, cex.axis=1.3,mar=c(0,5,2,2))
layout(matrix(c(1,2,2,2,3,4,4,4),nrow = 4,byrow = F))

PQ_11 = PQdat %>% filter(label=='PQ-mrdt01-011') %>% group_by(Day) %>%
  mutate(PQdose = sum(PQdose),
         Haemocue_hb = mean(Haemocue_hb, na.rm=T),
         Manual_retic = mean(Manual_retic, na.rm=T),
         CBC_hb = mean(CBC_hb, na.rm = T))

plot(PQ_11$Time, PQ_11$PQdose,
     ylab='Primaquine dose (mg)',xlab='',xaxt='n',type='l',lwd=3,
     panel.first = grid())
par(mar=c(5,5,0,2))
plot(PQ_11$Time, PQ_11$Haemocue_hb,
     xlab='Day since starting PQ', ylab = 'Haemoglobin (g/dL)', 
     panel.first = grid(), pch=16, cex=1.5)
points(PQ_11$Time, PQ_11$CBC_hb,
       pch=15, cex=1.5, col='red')

par(mar=c(0,5,2,2))
plot(PQ_11$Time, PQ_11$PQdose,
     ylab='PQ (mg)',xlab='',xaxt='n',type='l',lwd=3,
     panel.first = grid())
par(mar=c(5,5,0,2))
plot(PQ_11$Time, PQ_11$Manual_retic,
     xlab='Day since starting PQ', ylab = 'Reticulocytes (%)', 
     panel.first = grid(), pch=16, cex=1.5)
points(PQ_11$Time, PQ_11$CBC_retic,
       pch=15, cex=1.5, col='red')

```
